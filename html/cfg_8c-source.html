<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>CUPL (Common UNIX Programming Library): src/cfg.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<div class="nav">
<a class="el" href="dir_000002.html">src</a></div>
<h1>cfg.c</h1><a href="cfg_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> *  Copyright (C) 2006  Baris Simsek, http://www.enderunix.org/simsek</span>
00003 <span class="comment"> *  </span>
00004 <span class="comment"> *  This library is free software; you can redistribute it and/or</span>
00005 <span class="comment"> *  modify it under the terms of the GNU Lesser General Public</span>
00006 <span class="comment"> *  License as published by the Free Software Foundation; either</span>
00007 <span class="comment"> *  version 2.1 of the License, or (at your option) any later version.</span>
00008 <span class="comment"> *  </span>
00009 <span class="comment"> *  This library is distributed in the hope that it will be useful,</span>
00010 <span class="comment"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
00012 <span class="comment"> *  Lesser General Public License for more details.</span>
00013 <span class="comment"> *  </span>
00014 <span class="comment"> *  You should have received a copy of the GNU Lesser General Public</span>
00015 <span class="comment"> *  License along with this library; if not, write to the Free Software</span>
00016 <span class="comment"> *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span>
00017 <span class="comment"> *  </span>
00018 <span class="comment"> *  $Id: cfg_8c-source.html,v 1.5 2006/08/26 09:46:17 simsek Exp $</span>
00019 <span class="comment"> *  </span>
00020 <span class="comment"> *  Common Config Parser</span>
00021 <span class="comment"> *</span>
00022 <span class="comment"> */</span>
00023 
00024 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00025 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00026 <span class="preprocessor">#include &lt;<a class="code" href="string_8h.html">string.h</a>&gt;</span>
00027 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00028 
00029 <span class="preprocessor">#include "../include/cupl.h"</span>
00030 <span class="preprocessor">#include "../include/cfg.h"</span>
00031 
00032 <span class="keyword">extern</span> <span class="keywordtype">int</span> errno;
00033 
00034 <span class="keyword">static</span> <span class="keywordtype">int</span> parse_config_file(<a class="code" href="structcfg__data.html">cfg_data</a> *cfg);
00035 <span class="keyword">static</span> <span class="keywordtype">void</span> add_cfg_array(<a class="code" href="structcfg__data.html">cfg_data</a> *cfg, <span class="keywordtype">char</span> *var, <span class="keywordtype">char</span> *val);
00036 <span class="keyword">static</span> <span class="keywordtype">void</span> release_cfg_array(<a class="code" href="structcfg__array.html">cfg_array</a> *head);
00037 
00038 <span class="comment">/* To alloc cfg_data object and open config file. */</span>
<a name="l00039"></a><a class="code" href="cfg_8c.html#a4">00039</a> <span class="keyword">extern</span> <a class="code" href="structcfg__data.html">cfg_data</a> *<a class="code" href="cfg_8c.html#a4">cupl_init_cfg</a>(<span class="keywordtype">char</span> *path)
00040 {
00041     <a class="code" href="structcfg__data.html">cfg_data</a> *cfg;
00042 
00043     <span class="keywordflow">if</span> ((cfg = (<a class="code" href="structcfg__data.html">cfg_data</a> *) malloc(<span class="keyword">sizeof</span>(<a class="code" href="structcfg__data.html">cfg_data</a>))) == NULL) {
00044         fprintf(stderr, <span class="stringliteral">"%s: %d: malloc(): %s.\n"</span>, __FILE__, __LINE__,
00045                 strerror(<a class="code" href="cfg_8c.html#a0">errno</a>));
00046         <span class="keywordflow">return</span> NULL;
00047     }
00048 
00049     <span class="keywordflow">if</span> ((cfg-&gt;<a class="code" href="structcfg__data.html#o1">cfd</a> = fopen(path, <span class="stringliteral">"r"</span>)) == NULL) {
00050         fprintf(stderr, <span class="stringliteral">"%s: %d: fopen(): %s.\n"</span>, __FILE__, __LINE__,
00051                 strerror(<a class="code" href="cfg_8c.html#a0">errno</a>));
00052         <span class="keywordflow">return</span> NULL;
00053     }
00054 
00055     cfg-&gt;<a class="code" href="structcfg__data.html#o2">vars</a> = NULL;
00056     cfg-&gt;<a class="code" href="structcfg__data.html#o0">nov</a> = 0;
00057 
00058     <span class="keywordflow">if</span> (parse_config_file(cfg) == -1)
00059         <span class="keywordflow">return</span> NULL;
00060     
00061     <span class="keywordflow">return</span> cfg;
00062 }
00063 
00064 <span class="comment">/* To free cfg_data object and close config file. */</span>
<a name="l00065"></a><a class="code" href="cfg_8c.html#a5">00065</a> <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="cfg_8c.html#a5">cupl_release_cfg</a>(<a class="code" href="structcfg__data.html">cfg_data</a> *cfg)
00066 {
00067     <span class="keywordflow">if</span> (cfg == NULL) <span class="keywordflow">return</span> 0;
00068 
00069     fclose(cfg-&gt;<a class="code" href="structcfg__data.html#o1">cfd</a>);
00070 
00071     <span class="keywordflow">if</span> (cfg-&gt;<a class="code" href="structcfg__data.html#o2">vars</a>) release_cfg_array(cfg-&gt;<a class="code" href="structcfg__data.html#o2">vars</a>);
00072 
00073     free(cfg);
00074 
00075     <span class="keywordflow">return</span> 1;
00076 }
00077 
00078 <span class="comment">/* To release cfg_array linked list. */</span>
00079 <span class="keyword">static</span> <span class="keywordtype">void</span> release_cfg_array(<a class="code" href="structcfg__array.html">cfg_array</a> *head)
00080 {
00081     <a class="code" href="structcfg__array.html">cfg_array</a> *prev = head;
00082     <a class="code" href="structcfg__array.html">cfg_array</a> *next = head-&gt;<a class="code" href="structcfg__array.html#o2">next</a>;
00083 
00084     <span class="keywordflow">while</span> (prev != NULL) {
00085         <span class="comment">/* Save coming chain */</span>
00086         next = prev-&gt;<a class="code" href="structcfg__array.html#o2">next</a>;
00087 
00088         free(prev);
00089 
00090         <span class="comment">/* Move next */</span>
00091         prev = next;
00092         <span class="keywordflow">if</span> (prev) next = prev-&gt;<a class="code" href="structcfg__array.html#o2">next</a>;
00093     }
00094     
00095     <span class="keywordflow">return</span>;
00096 }
00097 
00098 <span class="comment">/* Parse the config file. */</span>
00099 <span class="keyword">static</span> <span class="keywordtype">int</span> parse_config_file(<a class="code" href="structcfg__data.html">cfg_data</a> *cfg)
00100 {
00101     <span class="keywordtype">int</span> i, j;
00102     <span class="keywordtype">int</span> lcnt = 0;
00103     <span class="keywordtype">int</span> blen;
00104     <span class="keywordtype">char</span> buf[CFG_VAL_LEN];
00105     <span class="keywordtype">char</span> val[CFG_VAL_LEN];
00106     <span class="keywordtype">char</span> var[CFG_VAR_LEN];
00107     <span class="keywordtype">char</span> ch;
00108 
00109     memset(buf, 0, CFG_VAL_LEN);
00110 
00111     <span class="keywordflow">while</span> (fgets(buf, CFG_VAL_LEN, cfg-&gt;<a class="code" href="structcfg__data.html#o1">cfd</a>)) {
00112         lcnt++;
00113         ch = buf[0];
00114         blen = strlen(buf) - 1;
00115 
00116         <span class="comment">/* Comments or spaces. Skip. */</span>
00117         <span class="keywordflow">if</span> (USELESS_LINE) {
00118             <span class="keywordflow">goto</span> loop_end;
00119         }
00120 
00121         <span class="comment">/* Invalid chars. Report and skip. */</span>
00122         <span class="keywordflow">if</span> (INVALID) {
00123             fprintf(stderr, <span class="stringliteral">"parse_config_file: Invalid character at line %d.\n"</span>, lcnt);
00124             <span class="keywordflow">goto</span> loop_end;
00125         }
00126 
00127         <span class="keywordflow">if</span> (IDENTIFIER) {
00128             fprintf(stderr, <span class="stringliteral">"parse_config_file: Variables must start with a char, line: %d.\n"</span>, lcnt);
00129             <span class="keywordflow">goto</span> loop_end;
00130         }
00131 
00132         <span class="comment">/* Valid identifier. */</span>
00133 
00134         <span class="comment">/* Get variable */</span>
00135         memset(var, 0, CFG_VAR_LEN);
00136         <span class="keywordflow">for</span> (i=0;i&lt;blen;i++) {
00137             ch = buf[i];
00138             <span class="keywordflow">if</span> (END_OF_LINE) {
00139                 fprintf(stderr, <span class="stringliteral">"parse_config_file: Syntax error at line %d.\n"</span>, lcnt);
00140                 <span class="keywordflow">goto</span> loop_end;
00141             }
00142             <span class="keywordflow">if</span> (INVALID) {
00143                 fprintf(stderr, <span class="stringliteral">"parse_config_file: Invalid character at line %d.\n"</span>, lcnt);
00144                 <span class="keywordflow">goto</span> loop_end;
00145             }
00146             <span class="keywordflow">if</span> (SEPERATOR) {
00147                 <span class="keywordflow">break</span>;
00148             }
00149             <span class="keywordflow">if</span> (i &lt; <a class="code" href="cupl_8h.html#a1">CFG_VAR_LEN</a> - 1)
00150                 var[i] = ch;
00151             <span class="keywordflow">else</span> {
00152                 fprintf(stderr, <span class="stringliteral">"parse_config_file: Too long variable name at line %d.\n"</span>, lcnt);
00153                 <span class="keywordflow">goto</span> loop_end;
00154             }
00155         }
00156 
00157         i++;
00158 
00159         <span class="comment">/* Skip extra seperators. */</span>
00160         <span class="keywordflow">for</span>(j=i;j&lt;blen;j++) {
00161             ch = buf[j];
00162             <span class="keywordflow">if</span> (SEPERATOR)
00163                 <span class="keywordflow">continue</span>;
00164             <span class="keywordflow">else</span>
00165                 <span class="keywordflow">break</span>;
00166         }
00167 
00168         i = j;
00169 
00170         <span class="comment">/* Get value */</span>
00171         memset(val, 0, CFG_VAL_LEN);
00172         <span class="keywordflow">for</span> (j=i;j&lt;blen;j++) {
00173             ch = buf[j];
00174             <span class="keywordflow">if</span> (END_OF_LINE) {
00175                 <span class="keywordflow">break</span>;
00176             }
00177             <span class="keywordflow">if</span> (INVALID) {
00178                 fprintf(stderr, <span class="stringliteral">"parse_config_file: Invalid character at line %d.\n"</span>, lcnt);
00179                 <span class="keywordflow">goto</span> loop_end;
00180             }
00181             <span class="keywordflow">if</span> ((j - i) &lt; (<a class="code" href="cupl_8h.html#a2">CFG_VAL_LEN</a> - 1))
00182                 val[j-i] = ch;
00183             <span class="keywordflow">else</span> {
00184                 fprintf(stderr, <span class="stringliteral">"parse_config_file: Too long value at line %d.\n"</span>, lcnt);
00185                 <span class="keywordflow">goto</span> loop_end;
00186             }
00187         }
00188 
00189         add_cfg_array(cfg, var, val);
00190 
00191         cfg-&gt;<a class="code" href="structcfg__data.html#o0">nov</a> = cfg-&gt;<a class="code" href="structcfg__data.html#o0">nov</a> + 1;
00192 
00193 loop_end:
00194         memset(buf, 0, CFG_VAL_LEN);
00195     }
00196 
00197     <span class="keywordflow">return</span> 1;
00198 }
00199 
00200 <span class="comment">/* Add new item to cfg_array linked list. */</span>
00201 <span class="keyword">static</span> <span class="keywordtype">void</span> add_cfg_array(<a class="code" href="structcfg__data.html">cfg_data</a> *cfg, <span class="keywordtype">char</span> *var, <span class="keywordtype">char</span> *val)
00202 {
00203     <a class="code" href="structcfg__array.html">cfg_array</a> *tail;
00204     <a class="code" href="structcfg__array.html">cfg_array</a> *cfgp;
00205 
00206     tail = cfg-&gt;<a class="code" href="structcfg__data.html#o2">vars</a>;
00207 
00208     <span class="keywordflow">if</span> (tail != NULL)
00209         <span class="keywordflow">while</span> (tail-&gt;<a class="code" href="structcfg__array.html#o2">next</a> != NULL)
00210             tail = tail-&gt;<a class="code" href="structcfg__array.html#o2">next</a>;
00211 
00212     <span class="keywordflow">if</span> ((cfgp = (<a class="code" href="structcfg__array.html">cfg_array</a> *) malloc(<span class="keyword">sizeof</span>(<a class="code" href="structcfg__array.html">cfg_array</a>))) == NULL) {
00213         fprintf(stderr, <span class="stringliteral">"%s: %d: malloc(): %s.\n"</span>, __FILE__, __LINE__, strerror(errno));
00214         <span class="keywordflow">return</span>;
00215     }
00216 
00217     strncpy(cfgp-&gt;<a class="code" href="structcfg__array.html#o0">var</a>, var, CFG_VAR_LEN-1);
00218     strncpy(cfgp-&gt;<a class="code" href="structcfg__array.html#o1">val</a>, val, CFG_VAL_LEN-1);
00219     cfgp-&gt;<a class="code" href="structcfg__array.html#o2">next</a> = NULL;
00220 
00221     <span class="keywordflow">if</span> (cfg-&gt;<a class="code" href="structcfg__data.html#o2">vars</a> == NULL) {
00222         cfg-&gt;<a class="code" href="structcfg__data.html#o2">vars</a> = cfgp;
00223     }
00224     <span class="keywordflow">else</span> {
00225         tail-&gt;<a class="code" href="structcfg__array.html#o2">next</a> = cfgp;
00226     }
00227 
00228 
00229     <span class="keywordflow">return</span>;
00230 }
00231 
00232 <span class="comment">/* To print all the parsed items */</span>
<a name="l00233"></a><a class="code" href="cfg_8c.html#a6">00233</a> <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="cfg_8c.html#a6">cupl_print_items</a>(<a class="code" href="structcfg__data.html">cfg_data</a> *cfg)
00234 {
00235     <a class="code" href="structcfg__array.html">cfg_array</a> *tmp;
00236 
00237     <span class="keywordflow">if</span> (cfg == NULL) <span class="keywordflow">return</span>;
00238 
00239     printf(<span class="stringliteral">"Number of items parsed: %d\n\n"</span>, cfg-&gt;<a class="code" href="structcfg__data.html#o0">nov</a>);
00240     printf(<span class="stringliteral">"Items:\n"</span>);
00241 
00242     tmp = cfg-&gt;<a class="code" href="structcfg__data.html#o2">vars</a>;
00243 
00244     <span class="keywordflow">while</span> (tmp != NULL) {
00245         printf(<span class="stringliteral">"%s: %s\n"</span>, tmp-&gt;<a class="code" href="structcfg__array.html#o0">var</a>, tmp-&gt;<a class="code" href="structcfg__array.html#o1">val</a>);
00246         tmp = tmp-&gt;<a class="code" href="structcfg__array.html#o2">next</a>;
00247     }
00248 
00249     <span class="keywordflow">return</span>;
00250 }
00251 
00252 <span class="comment">/* To get a variable from cfg_data object */</span>
<a name="l00253"></a><a class="code" href="cfg_8c.html#a7">00253</a> <span class="keyword">extern</span> <span class="keywordtype">char</span> *<a class="code" href="cfg_8c.html#a7">cupl_get_var</a>(<span class="keywordtype">char</span> *var, <a class="code" href="structcfg__data.html">cfg_data</a> *cfg)
00254 {
00255     <a class="code" href="structcfg__array.html">cfg_array</a> *tmp = cfg-&gt;<a class="code" href="structcfg__data.html#o2">vars</a>;
00256 
00257     <span class="keywordflow">if</span> (cfg == NULL) <span class="keywordflow">return</span> NULL;
00258 
00259     <span class="keywordflow">while</span> (tmp != NULL) {
00260         <span class="keywordflow">if</span> (strncmp(tmp-&gt;<a class="code" href="structcfg__array.html#o0">var</a>, var, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structcfg__array.html#o0">var</a>)) == 0) 
00261             <span class="keywordflow">return</span> tmp-&gt;<a class="code" href="structcfg__array.html#o1">val</a>;
00262         tmp = tmp-&gt;<a class="code" href="structcfg__array.html#o2">next</a>;
00263     }
00264 
00265     <span class="keywordflow">return</span> NULL;
00266 }
00267 
00268 
00269 
00270 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Aug 26 12:46:08 2006 for CUPL (Common UNIX Programming Library) by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
